<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    writeBatch,
    doc,
    query,
    where,
    orderBy,
    getDocs,
    Timestamp,
    limit,
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // ==========================================
  // CONFIGURATION (ของท่านจริง)
  // ==========================================
  const firebaseConfig = {
    apiKey: "AIzaSyBJaOWw1sBJhdqIL0r0SmuXnNv3IimJ8EQ",
    authDomain: "wy-salesreport.firebaseapp.com",
    projectId: "wy-salesreport",
    storageBucket: "wy-salesreport.firebasestorage.app",
    messagingSenderId: "60076528808",
    appId: "1:60076528808:web:e607be516901eddcac1e9d",
    measurementId: "G-400WR05KDG",
  };

  // ใช้ collection เดียวกับที่มีข้อมูลอยู่แล้วใน Firestore
  const COLLECTION = "sales_records";

  let db, auth;
  let chartInstance = null;

  // UI Elements
  const statusBadge = document.getElementById("statusBadge");
  const importBtn = document.getElementById("importBtn");
  const fileInput = document.getElementById("csvInput");
  const progressBar = document.getElementById("progressBar");
  const progressArea = document.getElementById("progressArea");
  const progressText = document.getElementById("progressText");
  const progressPercent = document.getElementById("progressPercent");
  const importMsg = document.getElementById("importMsg");
  const clearDbBtn = document.getElementById("clearDbBtn");

  // ==========================================
  // DATE FORMAT UTILITIES  (dd/mm/yy)
  // ==========================================
  function pad2(n) {
    return n < 10 ? "0" + n : "" + n;
  }

  // ใช้กับ string "YYYY-MM-DD" หรือ "YYYY-MM-DD HH:00"
  function formatLabelToDDMMYY(label) {
    // มีเวลาอยู่ด้วย
    if (label.includes(" ")) {
      const [datePart, timePart] = label.split(" ");
      const [y, m, d] = datePart.split("-").map((x) => parseInt(x, 10));
      const [hh] = timePart.split(":").map((x) => parseInt(x, 10));
      const date = new Date(y, m - 1, d, hh);
      return `${pad2(date.getDate())}/${pad2(
        date.getMonth() + 1
      )}/${date.getFullYear().toString().slice(-2)} ${pad2(
        date.getHours()
      )}:00`;
    } else {
      const [y, m, d] = label.split("-").map((x) => parseInt(x, 10));
      const date = new Date(y, m - 1, d);
      return `${pad2(date.getDate())}/${pad2(
        date.getMonth() + 1
      )}/${date.getFullYear().toString().slice(-2)}`;
    }
  }

  function formatDateISO(date) {
    return date.toISOString().split("T")[0]; // YYYY-MM-DD
  }
  function formatTimeISO(date) {
    return date.toTimeString().split(" ")[0]; // HH:mm:ss
  }

  // แปลงวันที่ไทยจาก CSV => Date
  function parseThaiDate(str) {
    // Expected: "D/M/YYYY HH:mm" เช่น "1/11/2568 10:04"
    try {
      const [datePart, timePart] = str.trim().split(" ");
      const [d, m, y] = datePart.split("/");

      let year = parseInt(y, 10);
      if (year > 2400) year -= 543; // BE -> AD

      let h = 0,
        min = 0;
      if (timePart) {
        const [hh, mm] = timePart.split(":");
        h = parseInt(hh, 10);
        min = parseInt(mm, 10);
      }
      return new Date(year, parseInt(m, 10) - 1, parseInt(d, 10), h, min);
    } catch (e) {
      return null;
    }
  }

  // ==========================================
  // INIT FIREBASE
  // ==========================================
  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        statusBadge.className =
          "inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200 transition-all";
        statusBadge.innerHTML =
          '<span class="w-2 h-2 mr-2 bg-emerald-500 rounded-full"></span>Connected';

        importBtn.disabled = false;
        clearDbBtn.classList.remove("hidden");

        // โหลดค่าเริ่มต้น 30 วันล่าสุด
        setQuickRange(30);
      } else {
        signInAnonymously(auth).catch((err) => {
          console.error(err);
          statusBadge.innerHTML = "Auth Failed";
          statusBadge.classList.add("text-red-600", "bg-red-50");
        });
      }
    });
  } catch (e) {
    console.error("Firebase Init Error", e);
    statusBadge.innerHTML = "Config Error";
    statusBadge.classList.add("text-red-600", "bg-red-50");
    importMsg.textContent = "Error: Check your Firebase Config in the code.";
  }

  // ==========================================
  // CSV PARSING & UPLOAD
  // ==========================================
  importBtn.addEventListener("click", () => {
    const file = fileInput.files[0];
    if (!file) return alert("Please select a CSV file.");

    // Reset UI
    importBtn.disabled = true;
    progressArea.classList.remove("hidden");
    importMsg.textContent = "";
    progressBar.style.width = "0%";
    progressPercent.textContent = "0%";
    progressText.textContent = "Processing...";

    Papa.parse(file, {
      header: false, // ใช้อ้าง index ตามที่กำหนด
      skipEmptyLines: true,
      complete: async (results) => {
        const data = results.data;
        const parsedRows = [];

        // index ตามที่ตกลง:
        // 1: Date (เช่น 1/11/2568 10:04)
        // 3: Product
        // 9: Qty
        // 10: Total
        // 11: Payment
        // 14: Branch

        for (let row of data) {
          if (row.length < 15) continue;

          const dateRaw = row[1];
          if (
            !dateRaw ||
            dateRaw.includes("Date") ||
            dateRaw.includes("วันที่")
          )
            continue; // ข้าม header

          const jsDate = parseThaiDate(dateRaw);
          if (!jsDate) continue;

          const qty = parseInt(row[9] || 0, 10);
          const total = parseFloat((row[10] || "0").replace(/,/g, ""));

          if (!isNaN(qty)) {
            parsedRows.push({
              transactionDate: formatDateISO(jsDate), // YYYY-MM-DD เก็บแบบนี้
              transactionTime: formatTimeISO(jsDate),
              timestamp: Timestamp.fromDate(jsDate),
              product: (row[3] || "Unknown").trim(),
              quantity: qty,
              pricePerSheet: qty > 0 ? total / qty : 0,
              totalAmount: total,
              paymentType: (row[11] || "Unknown").trim(),
              branchName: (row[14] || "Unknown").trim(),
            });
          }
        }

        if (parsedRows.length === 0) {
          finishImport("No valid rows found.", true);
          return;
        }

        await uploadBatches(parsedRows);
      },
      error: (err) => finishImport("CSV Error: " + err.message, true),
    });
  });

  async function uploadBatches(rows) {
    const batchSize = 500;
    const total = rows.length;
    let current = 0;

    try {
      for (let i = 0; i < total; i += batchSize) {
        const batch = writeBatch(db);
        const chunk = rows.slice(i, i + batchSize);

        chunk.forEach((data) => {
          const ref = doc(collection(db, COLLECTION));
          batch.set(ref, data);
        });

        await batch.commit();
        current += chunk.length;

        const pct = Math.round((current / total) * 100);
        progressBar.style.width = `${pct}%`;
        progressPercent.textContent = `${pct}%`;
        progressText.textContent = `Uploaded ${current}/${total}`;
      }

      finishImport(`Successfully imported ${total} records!`);
      document.getElementById("filterBtn").click();
    } catch (err) {
      console.error(err);
      finishImport("Upload Failed: " + err.message, true);
    }
  }

  function finishImport(msg, isError = false) {
    importBtn.disabled = false;
    importMsg.textContent = msg;
    importMsg.className = isError
      ? "mt-2 text-sm text-red-600 font-medium"
      : "mt-2 text-sm text-emerald-600 font-medium";

    if (!isError) {
      setTimeout(() => progressArea.classList.add("hidden"), 3000);
    }
  }

  // ==========================================
  // DATA QUERY & VISUALIZATION
  // ==========================================
  const dateFromEl = document.getElementById("dateFrom");
  const dateToEl = document.getElementById("dateTo");

  document.getElementById("filterBtn").addEventListener("click", () => {
    loadData(dateFromEl.value, dateToEl.value);
  });

  document.querySelectorAll(".quick-filter").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      document.querySelectorAll(".quick-filter").forEach((b) => {
        b.classList.remove("bg-indigo-600", "text-white", "border-indigo-600");
        b.classList.add("bg-white", "text-slate-600");
      });
      e.target.classList.remove("bg-white", "text-slate-600");
      e.target.classList.add("bg-indigo-600", "text-white", "border-indigo-600");

      setQuickRange(parseInt(e.target.dataset.days, 10));
    });
  });

  function setQuickRange(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);

    dateFromEl.value = formatDateISO(start);
    dateToEl.value = formatDateISO(end);
    loadData(dateFromEl.value, dateToEl.value);
  }

  async function loadData(startStr, endStr) {
    if (!startStr || !endStr) return;

    document.body.style.cursor = "wait";
    const filterBtn = document.getElementById("filterBtn");
    const originalText = filterBtn.textContent;
    filterBtn.textContent = "Loading...";
    filterBtn.disabled = true;

    try {
      const startDate = new Date(startStr);
      startDate.setHours(0, 0, 0, 0);
      const endDate = new Date(endStr);
      endDate.setHours(23, 59, 59, 999);

      const qSnap = await getDocs(
        query(
          collection(db, COLLECTION),
          where("timestamp", ">=", Timestamp.fromDate(startDate)),
          where("timestamp", "<=", Timestamp.fromDate(endDate)),
          orderBy("timestamp", "asc")
        )
      );

      const records = qSnap.docs.map((d) => d.data());
      renderDashboard(records, startDate, endDate);
    } catch (err) {
      console.error(err);
      if (err.message.includes("requires an index")) {
        alert(
          "Firestore Index Missing! Please open the console and click the index creation link."
        );
      } else {
        alert("Error loading data: " + err.message);
      }
    } finally {
      document.body.style.cursor = "default";
      filterBtn.textContent = originalText;
      filterBtn.disabled = false;
    }
  }

  function renderDashboard(data, start, end) {
    let totalSales = 0;
    let totalQty = 0;
    const productMap = {};
    const branchMap = {};
    const timeMap = {};

    const daysDiff = (end - start) / (1000 * 60 * 60 * 24);
    const groupByHour = daysDiff <= 3;

    data.forEach((item) => {
      totalSales += item.totalAmount;
      totalQty += item.quantity;

      if (!productMap[item.product])
        productMap[item.product] = { qty: 0, sales: 0 };
      productMap[item.product].qty += item.quantity;
      productMap[item.product].sales += item.totalAmount;

      if (!branchMap[item.branchName])
        branchMap[item.branchName] = { qty: 0, sales: 0 };
      branchMap[item.branchName].qty += item.quantity;
      branchMap[item.branchName].sales += item.totalAmount;

      const d = item.timestamp.toDate();
      let key;
      if (groupByHour) {
        key = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(
          d.getDate()
        )} ${pad2(d.getHours())}:00`;
      } else {
        key = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(
          d.getDate()
        )}`;
      }

      if (!timeMap[key]) timeMap[key] = 0;
      timeMap[key] += item.totalAmount;
    });

    const fmtCurrency = new Intl.NumberFormat("th-TH", {
      style: "currency",
      currency: "THB",
    });
    const fmtInt = new Intl.NumberFormat("en-US");

    document.getElementById("valTotalSales").textContent =
      fmtCurrency.format(totalSales);
    document.getElementById("valTotalQty").textContent =
      fmtInt.format(totalQty);
    document.getElementById("valAvgPrice").textContent = totalQty
      ? fmtCurrency.format(totalSales / totalQty)
      : "฿0.00";

    updateChart(timeMap);
    updateTable("tableProducts", productMap);
    updateTable("tableBranches", branchMap);
  }

  function updateChart(timeMap) {
    const ctx = document.getElementById("mainChart").getContext("2d");
    const rawLabels = Object.keys(timeMap).sort();
    const labels = rawLabels.map((l) => formatLabelToDDMMYY(l));
    const data = rawLabels.map((l) => timeMap[l]);

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Sales Amount",
            data,
            backgroundColor: "#4f46e5",
            borderRadius: 4,
            barPercentage: 0.6,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) =>
                new Intl.NumberFormat("th-TH", {
                  style: "currency",
                  currency: "THB",
                }).format(ctx.raw),
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { borderDash: [2, 4], color: "#f1f5f9" },
            ticks: { color: "#94a3b8", font: { size: 11 } },
          },
          x: {
            grid: { display: false },
            ticks: {
              color: "#94a3b8",
              font: { size: 11 },
              maxTicksLimit: 10,
            },
          },
        },
      },
    });
  }

  function updateTable(id, map) {
    const tbody = document.getElementById(id);
    tbody.innerHTML = "";

    const entries = Object.entries(map);
    if (entries.length === 0) {
      tbody.innerHTML =
        '<tr><td colspan="3" class="px-6 py-4 text-center text-xs text-slate-400">No data</td></tr>';
      return;
    }

    // แก้ syntax: b[1].sales ไม่ใช่ b.1.sales
    const sorted = entries.sort((a, b) => b[1].sales - a[1].sales);
    const fmt = new Intl.NumberFormat("th-TH", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });

    sorted.forEach(([name, stats]) => {
      const tr = document.createElement("tr");
      tr.className = "hover:bg-slate-50 transition-colors";
      tr.innerHTML = `
        <td class="px-6 py-3 whitespace-nowrap text-xs font-medium text-slate-800">${name}</td>
        <td class="px-6 py-3 whitespace-nowrap text-xs text-slate-500 text-right">${stats.qty}</td>
        <td class="px-6 py-3 whitespace-nowrap text-xs text-slate-600 text-right font-mono">${fmt.format(
          stats.sales
        )}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Clear DB (ลบทั้งหมดใน collection นี้)
  clearDbBtn.addEventListener("click", async () => {
    if (
      !confirm(
        "Warning: This will delete ALL sales transactions in Firestore. Continue?"
      )
    )
      return;

    clearDbBtn.textContent = "Clearing...";
    clearDbBtn.disabled = true;

    let count = 0;
    while (true) {
      const snap = await getDocs(
        query(collection(db, COLLECTION), limit(100))
      );
      if (snap.empty) break;

      const batch = writeBatch(db);
      snap.docs.forEach((d) => batch.delete(d.ref));
      await batch.commit();
      count += snap.size;
    }

    alert(`Deleted ${count} records.`);
    clearDbBtn.textContent = "Reset DB";
    clearDbBtn.disabled = false;
    renderDashboard([], new Date(), new Date());
  });
</script>
