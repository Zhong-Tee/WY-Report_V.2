<script type="module">
    // ============================
    // 1. Supabase CONFIG
    // ============================
    const SUPABASE_URL = "https://lgaobgxeybmlrbsjgnfh.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Y6fHy4gC6BCUua_XzjEkBQ_xjeX1qGe";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const statusBadge = document.getElementById("firebaseStatus");
    const clearDataBtn = document.getElementById("clearDataBtn");

    const COLLECTION_NAME = "sales_records";

    // แสดงสถานะว่าเชื่อมต่อแล้ว
    statusBadge.innerHTML =
        '<span class="w-2 h-2 mr-1.5 bg-green-500 rounded-full"></span>Connected';
    statusBadge.classList.remove("bg-slate-100", "text-slate-600");
    statusBadge.classList.add("bg-green-50", "text-green-700", "border-green-200");

    document.getElementById("importBtn").disabled = false;
    clearDataBtn.classList.remove("hidden");

    // ให้โหลด default = Last 1 Month ทันที
    setTimeout(() => triggerQuickFilter("1m"), 300);

    // ============================
    // 2. DOM ELEMENTS
    // ============================
    const fileInput = document.getElementById("csvFileInput");
    const importBtn = document.getElementById("importBtn");
    const progressBar = document.getElementById("progressBar");
    const importStatusText = document.getElementById("importStatusText");
    const importMessage = document.getElementById("importMessage");
    const importProgressContainer = document.getElementById("importProgress");

    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const quickFilterBtns = document.querySelectorAll(".quick-filter-btn");

    let currentChart = null;
    let weeklyChart = null;

    // ============================
    // 3. PARSE DATE & TRANSFORM ROW
    // ============================
    function parseCustomDate(dateStr) {
        if (!dateStr) return null;

        const parts = dateStr.trim().split(" ");
        const datePart = parts[0];
        const timePart = parts.length > 1 ? parts[1] : "00:00:00";

        if (datePart.includes("/")) {
            const dateSegments = datePart.split("/");
            if (dateSegments.length === 3) {
                let day = parseInt(dateSegments[0], 10);
                let month = parseInt(dateSegments[1], 10) - 1;
                let year = parseInt(dateSegments[2], 10);

                // ถ้าเป็น พ.ศ. ให้แปลงเป็น ค.ศ.
                if (year > 2400) year -= 543;

                const timeSegments = timePart.split(":");
                let hours = 0, minutes = 0, seconds = 0;
                if (timeSegments.length >= 2) {
                    hours = parseInt(timeSegments[0], 10);
                    minutes = parseInt(timeSegments[1], 10);
                    if (timeSegments.length === 3)
                        seconds = parseInt(timeSegments[2], 10);
                }
                return new Date(year, month, day, hours, minutes, seconds);
            }
        }

        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? null : d;
    }

    function transformRow(row) {
        // row index mapping ยังคงตาม ไฟล์เดิม
        if (row.length < 15) return null;

        const dateTimeRaw = row[1];
        if (!dateTimeRaw || dateTimeRaw.includes("วันที่") || dateTimeRaw.includes("Date"))
            return null;

        const jsDate = parseCustomDate(dateTimeRaw);
        if (!jsDate || isNaN(jsDate.getTime())) return null;

        const quantity = parseInt(row[9] || "0", 10);
        const total = parseFloat((row[10] || "0").replace(/,/g, ""));
        const price = quantity > 0 ? total / quantity : 0;

        const yyyy = jsDate.getFullYear();
        const mm = String(jsDate.getMonth() + 1).padStart(2, "0");
        const dd = String(jsDate.getDate()).padStart(2, "0");
        const dateString = `${yyyy}-${mm}-${dd}`;
        const timeString = jsDate.toTimeString().split(" ")[0];

        // ชื่อ field ให้ตรงกับ column ใน Supabase (sales_records)
        return {
            transactiondate: dateString,           // type: date
            transactiontime: timeString,           // text / time แล้วแต่ที่ตั้งไว้
            timestamp: jsDate.toISOString(),       // timestamptz
            product: (row[3] || "Unknown").trim(),
            quantity: quantity,
            pricepersheet: parseFloat(price.toFixed(2)),
            totalamount: total,
            paymenttype: (row[11] || "Unknown").trim(),
            branchname: (row[14] || "Unknown").trim()
        };
    }

    // ============================
    // 4. IMPORT CSV → SUPABASE
    // ============================
    importBtn.addEventListener("click", () => {
        const file = fileInput.files[0];
        if (!file) {
            alert("Please select a CSV file first.");
            return;
        }

        importProgressContainer.classList.remove("hidden");
        importMessage.textContent = "Parsing CSV...";
        importMessage.className = "mt-2 text-sm text-slate-600";
        importBtn.disabled = true;

        Papa.parse(file, {
            header: false,
            skipEmptyLines: true,
            complete: async (results) => {
                const rows = results.data;
                const parsedData = [];

                for (let i = 0; i < rows.length; i++) {
                    const record = transformRow(rows[i]);
                    if (record) parsedData.push(record);
                }

                if (parsedData.length === 0) {
                    importMessage.textContent = "No valid data rows found.";
                    importMessage.className = "mt-2 text-sm text-red-600";
                    importBtn.disabled = false;
                    importProgressContainer.classList.add("hidden");
                    return;
                }

                await saveCsvRows(parsedData);
            },
            error: (err) => {
                importMessage.textContent = "Error parsing CSV: " + err.message;
                importMessage.className = "mt-2 text-sm text-red-600";
                importBtn.disabled = false;
            }
        });
    });

    async function saveCsvRows(data) {
        importMessage.textContent = `Uploading ${data.length} records to Supabase...`;

        const batchSize = 500;
        const totalBatches = Math.ceil(data.length / batchSize);
        let recordsUploaded = 0;

        try {
            for (let i = 0; i < totalBatches; i++) {
                const start = i * batchSize;
                const end = Math.min(start + batchSize, data.length);
                const chunk = data.slice(start, end);

                const { error } = await supabase
                    .from(COLLECTION_NAME)
                    .insert(chunk);

                if (error) throw error;

                recordsUploaded += chunk.length;
                const pct = Math.round((recordsUploaded / data.length) * 100);
                progressBar.style.width = `${pct}%`;
                importStatusText.textContent = `${pct}%`;
            }

            importMessage.textContent = "Upload Complete!";
            importMessage.className = "mt-2 text-sm text-green-600 font-medium";
            importBtn.disabled = false;

            triggerQuickFilter("1m");

            setTimeout(() => {
                importProgressContainer.classList.add("hidden");
                progressBar.style.width = "0%";
            }, 3000);
        } catch (error) {
            console.error("Upload failed", error);
            importMessage.textContent = "Upload failed: " + error.message;
            importMessage.className = "mt-2 text-sm text-red-600";
            importBtn.disabled = false;
        }
    }

    // ============================
    // 5. CLEAR DATA (DELETE ALL)
    // ============================
    clearDataBtn.addEventListener("click", async () => {
        if (!confirm("Delete ALL sales records from the database?")) return;

        clearDataBtn.disabled = true;
        clearDataBtn.textContent = "Clearing...";

        try {
            const { error } = await supabase
                .from(COLLECTION_NAME)
                .delete()
                .neq("id", null);   // ลบทุกแถว

            if (error) throw error;

            alert("Database cleared.");
            loadDataByDateRange(new Date(), new Date());
        } catch (error) {
            console.error("Clear failed", error);
            alert("Error clearing data: " + error.message);
        } finally {
            clearDataBtn.disabled = false;
            clearDataBtn.textContent = "Clear Database";
        }
    });

    // ============================
    // 6. FILTERS
    // ============================
    applyFilterBtn.addEventListener("click", () => {
        const start = startDateInput.value;
        const end = endDateInput.value;
        if (start && end) {
            loadDataByDateRange(new Date(start), new Date(end));
            updateActiveButton(null);
        } else {
            alert("Please select both start and end dates.");
        }
    });

    quickFilterBtns.forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const range = e.target.getAttribute("data-range");
            triggerQuickFilter(range);
            updateActiveButton(e.target);
        });
    });

    function updateActiveButton(activeBtn) {
        quickFilterBtns.forEach((btn) => {
            if (btn === activeBtn) {
                btn.classList.remove("bg-white", "text-slate-600", "border-slate-200");
                btn.classList.add("bg-indigo-600", "text-white", "border-indigo-600");
            } else {
                btn.classList.add("bg-white", "text-slate-600", "border-slate-200");
                btn.classList.remove("bg-indigo-600", "text-white", "border-indigo-600");
            }
        });
    }

    function triggerQuickFilter(range) {
        const end = new Date();
        const start = new Date();
        end.setHours(23, 59, 59, 999);

        if (range === "7d") {
            start.setDate(end.getDate() - 7);
        } else if (range === "1m") {
            start.setMonth(end.getMonth() - 1);
        } else if (range === "1y") {
            start.setFullYear(end.getFullYear() - 1);
        }
        start.setHours(0, 0, 0, 0);

        const formatDate = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        };

        startDateInput.value = formatDate(start);
        endDateInput.value = formatDate(end);

        loadDataByDateRange(start, end);
    }

    // ============================
    // 7. LOAD DATA FROM SUPABASE
    // ============================
    async function loadDataByDateRange(startDate, endDate) {
        document.body.style.cursor = "wait";
        applyFilterBtn.disabled = true;
        applyFilterBtn.textContent = "Loading...";

        try {
            const adjustedEndDate = new Date(endDate);
            adjustedEndDate.setHours(23, 59, 59, 999);

            const { data, error } = await supabase
                .from(COLLECTION_NAME)
                .select("*")
                .gte("timestamp", startDate.toISOString())
                .lte("timestamp", adjustedEndDate.toISOString())
                .order("timestamp", { ascending: true });

            if (error) throw error;

            const records = data || [];
            processAndRender(records, startDate, adjustedEndDate);
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("Error fetching data: " + error.message);
        } finally {
            document.body.style.cursor = "default";
            applyFilterBtn.disabled = false;
            applyFilterBtn.textContent = "Apply Filter";
        }
    }

    // ============================
    // 8. PROCESS & RENDER
    // ============================
    function processAndRender(records, startDate, endDate) {
        let totalSales = 0;
        let totalSheets = 0;
        const productStats = {};
        const branchStats = {};
        const timeSeriesData = {};

        const dayOfWeekStats = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 0: 0 };

        const timeDiff = endDate - startDate;
        const daysDiff = timeDiff / (1000 * 3600 * 24);
        const groupByHour = daysDiff <= 7;

        records.forEach((rec) => {
            const salesVal = Number(rec.totalamount) || 0;
            const qtyVal = Number(rec.quantity) || 0;

            totalSales += salesVal;
            totalSheets += qtyVal;

            const prodName = rec.product || "Unknown";
            if (!productStats[prodName]) productStats[prodName] = { sheets: 0, sales: 0 };
            productStats[prodName].sheets += qtyVal;
            productStats[prodName].sales += salesVal;

            const branchName = rec.branchname || "Unknown";
            if (!branchStats[branchName]) branchStats[branchName] = { sheets: 0, sales: 0 };
            branchStats[branchName].sheets += qtyVal;
            branchStats[branchName].sales += salesVal;

            if (rec.timestamp) {
                const dateObj = new Date(rec.timestamp);

                let key;
                if (groupByHour) {
                    const y = dateObj.getFullYear();
                    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
                    const d = String(dateObj.getDate()).padStart(2, "0");
                    const h = String(dateObj.getHours()).padStart(2, "0");
                    key = `${y}-${m}-${d} ${h}:00`;
                } else {
                    const y = dateObj.getFullYear();
                    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
                    const d = String(dateObj.getDate()).padStart(2, "0");
                    key = `${y}-${m}-${d}`;
                }
                if (!timeSeriesData[key]) timeSeriesData[key] = 0;
                timeSeriesData[key] += salesVal;

                const dayIdx = dateObj.getDay();
                dayOfWeekStats[dayIdx] += salesVal;
            }
        });

        const avgSales = totalSheets > 0 ? totalSales / totalSheets : 0;

        const currencyFmt = new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "THB"
        });
        const numberFmt = new Intl.NumberFormat("en-US");

        document.getElementById("kpiTotalSales").textContent = currencyFmt.format(totalSales);
        document.getElementById("kpiTotalSheets").textContent = numberFmt.format(totalSheets);
        document.getElementById("kpiAvgSales").textContent = currencyFmt.format(avgSales);

        renderTable("productTableBody", productStats);
        renderTable("branchTableBody", branchStats);
        renderChart(timeSeriesData);
        renderRawData(records.slice(0, 50));
        renderWeeklyAnalysis(dayOfWeekStats);
    }

    // Weekly analysis (เหมือนเดิม)
    function renderWeeklyAnalysis(dayStats) {
        const order = [1, 2, 3, 4, 5, 6, 0];
        const labels = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const shortLabels = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const dataValues = order.map(idx => dayStats[idx]);

        const currencyFmt = new Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        const tbody = document.getElementById("weeklyTableBody");
        tbody.innerHTML = "";
        let totalWeekly = 0;

        order.forEach((dayIdx, i) => {
            const val = dayStats[dayIdx];
            totalWeekly += val;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="px-4 py-2 text-sm text-slate-700">${labels[i]}</td>
                <td class="px-4 py-2 text-sm text-slate-700 text-right font-mono">${currencyFmt.format(val)}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById("weeklyTotalDisplay").textContent = currencyFmt.format(totalWeekly);

        const ctx = document.getElementById("weeklyChart").getContext("2d");
        if (weeklyChart) weeklyChart.destroy();

        weeklyChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: shortLabels,
                datasets: [{
                    label: "Sales by Day",
                    data: dataValues,
                    backgroundColor: "rgba(16, 185, 129, 0.7)",
                    borderColor: "rgb(16, 185, 129)",
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => currencyFmt.format(context.parsed.y)
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [2, 2] },
                        ticks: {
                            callback: (val) => val >= 1000 ? (val / 1000).toFixed(0) + "k" : val
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function renderTable(elementId, statsObj) {
        const tbody = document.getElementById(elementId);
        tbody.innerHTML = "";

        const sorted = Object.entries(statsObj)
            .map(([name, data]) => ({ name, ...data }))
            .sort((a, b) => b.sales - a.sales);

        const currencyFmt = new Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        const numberFmt = new Intl.NumberFormat("en-US");

        if (sorted.length === 0) {
            tbody.innerHTML =
                '<tr><td colspan="3" class="px-6 py-4 text-center text-sm text-slate-500">No data available</td></tr>';
            return;
        }

        sorted.forEach((item) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-50 transition-colors";
            tr.innerHTML = `
                <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-slate-900">
                    ${item.name}
                </td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-slate-600 text-right">
                    ${numberFmt.format(item.sheets)}
                </td>
                <td class="px-6 py-3 whitespace-nowrap text-sm text-slate-600 text-right font-mono">
                    ${currencyFmt.format(item.sales)}
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function renderRawData(records) {
        const tbody = document.getElementById("rawDataTableBody");
        tbody.innerHTML = "";
        const currencyFmt = new Intl.NumberFormat("en-US", { minimumFractionDigits: 2 });

        if (records.length === 0) {
            tbody.innerHTML =
                '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-slate-500">No records loaded</td></tr>';
            return;
        }

        records.forEach((rec) => {
            let dateStr = "N/A";
            if (rec.timestamp) {
                const d = new Date(rec.timestamp);
                const day = String(d.getDate()).padStart(2, "0");
                const month = String(d.getMonth() + 1).padStart(2, "0");
                const year = String(d.getFullYear()).slice(-2);
                const hh = String(d.getHours()).padStart(2, "0");
                const mm = String(d.getMinutes()).padStart(2, "0");
                dateStr = `${day}/${month}/${year} ${hh}:${mm}`;
            }

            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-50 transition-colors";
            tr.innerHTML = `
                <td class="px-4 py-2 text-sm text-slate-900 whitespace-nowrap">${dateStr}</td>
                <td class="px-4 py-2 text-sm text-slate-600 max-w-xs truncate" title="${rec.product}">
                    ${rec.product}
                </td>
                <td class="px-4 py-2 text-sm text-slate-600 max-w-xs truncate" title="${rec.branchname}">
                    ${rec.branchname}
                </td>
                <td class="px-4 py-2 text-sm text-slate-600 text-right">${rec.quantity}</td>
                <td class="px-4 py-2 text-sm text-slate-600 text-right font-mono">
                    ${currencyFmt.format(rec.totalamount)}
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function renderChart(dataObj) {
        const ctx = document.getElementById("salesChart").getContext("2d");
        const labels = Object.keys(dataObj).sort();
        const values = labels.map((k) => dataObj[k]);

        if (currentChart) currentChart.destroy();

        currentChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: "Total Sales",
                    data: values,
                    backgroundColor: "rgba(79, 70, 229, 0.7)",
                    borderColor: "rgb(79, 70, 229)",
                    borderWidth: 1,
                    borderRadius: 4,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: "rgba(15, 23, 42, 0.9)",
                        padding: 12,
                        titleFont: { size: 14 },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: (context) => {
                                if (context.parsed.y !== null) {
                                    return new Intl.NumberFormat("en-US", {
                                        style: "currency",
                                        currency: "THB"
                                    }).format(context.parsed.y);
                                }
                                return "";
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false, drawBorder: false },
                        ticks: { maxTicksLimit: 12, color: "#64748b" }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: "#f1f5f9", borderDash: [2, 2] },
                        ticks: {
                            color: "#64748b",
                            callback: (value) => {
                                if (value >= 1000) return (value / 1000).toFixed(0) + "k";
                                return value;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
